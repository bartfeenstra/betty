#!/usr/bin/env bash

set -Eeuo pipefail

cd "$(dirname "$0")/.."

if [ "$#" -ne 1 ]
then
  echo "This command takes a single argument, which is the version to release."
  exit 1
fi

RELEASE_VERSION=$1
RELEASE_BRANCH="release-$RELEASE_VERSION"
ORIGINAL_BRANCH=$(git branch --show-current)

# Check we are releasing a valid Semantic Version.
if [[ ! $RELEASE_VERSION =~ ^[0-9]{1,}\.[0-9]{1,}\.[0-9]{1,}$ ]]; then
    echo "$RELEASE_VERSION is not a valid Semantic Version (x.y.z). See https://semver.org/."
    exit 1
fi

# Check this version does not already exist.
git fetch --tags
if git tag | grep -q "^$RELEASE_VERSION$"; then
    echo "Version $RELEASE_VERSION already exists."
    exit 1
fi

# Check there are no uncommitted changes.
if ! git diff-index --quiet HEAD --; then
    echo 'The Git repository has uncommitted changes.'
    exit 1
fi

# Create the release branch.
git checkout -b "$RELEASE_BRANCH"

# Commit the release to Git.
echo "$RELEASE_VERSION" > ./betty/assets/RELEASE_VERSION
git add ./betty/assets/RELEASE_VERSION
git commit -m "Release version $RELEASE_VERSION."
git tag "$RELEASE_VERSION"

# Build and publish the package.
./bin/build-package
twine upload --repository-url https://upload.pypi.org/legacy/ ./dist/*

# Revert back to the original branch.
git checkout "$ORIGINAL_BRANCH"
git branch -D "release-$RELEASE_VERSION"

# Push changes.
git push origin "$RELEASE_VERSION"
